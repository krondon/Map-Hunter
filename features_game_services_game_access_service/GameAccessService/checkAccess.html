<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no">
  <meta name="description" content="API docs for the checkAccess method from the GameAccessService class, for the Dart programming language.">
  <title>checkAccess method - GameAccessService class - game_access_service library - Dart API</title>


  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  
  <link rel="stylesheet" href="../../static-assets/github.css?v1">
  <link rel="stylesheet" href="../../static-assets/styles.css?v1">
  <link rel="icon" href="../../static-assets/favicon.png?v1">
  
</head>

<body data-base-href="../../" data-using-base-href="false" class="light-theme">
<div id="overlay-under-drawer"></div>
<header id="title">
  <span id="sidenav-left-toggle" class="material-symbols-outlined" role="button" tabindex="0">menu</span>
  <ol class="breadcrumbs gt-separated dark hidden-xs">
    <li><a href="../../index.html">treasure_hunt_rpg</a></li>
    <li><a href="../../features_game_services_game_access_service/">features&#47;game&#47;services&#47;game_access_service.dart</a></li>
    <li><a href="../../features_game_services_game_access_service/GameAccessService-class.html">GameAccessService</a></li>
    <li class="self-crumb">checkAccess method</li>
  </ol>
  <div class="self-name">checkAccess</div>
  <form class="search navbar-right" role="search">
    <input type="text" id="search-box" autocomplete="off" disabled class="form-control typeahead" placeholder="Loading search...">
  </form>
  <button class="toggle" id="theme-button" title="Toggle between light and dark mode" aria-label="Light and dark mode toggle">
    <span id="dark-theme-button" class="material-symbols-outlined" aria-hidden="true">
      dark_mode
    </span>
    <span id="light-theme-button" class="material-symbols-outlined" aria-hidden="true">
      light_mode
    </span>
  </button>
</header>
<main>
<div
    id="dartdoc-main-content"
    class="main-content"
    data-above-sidebar="features_game_services_game_access_service&#47;GameAccessService-class-sidebar.html"
    data-below-sidebar="">
    <div>
<h1><span class="kind-method">checkAccess</span> method 
</h1></div>

    <section class="multi-line-signature">
      
<span class="returntype"><a href="https://api.flutter.dev/flutter/dart-core/Future-class.html">Future</a><span class="signature">&lt;<wbr><span class="type-parameter"><a href="../../features_game_services_game_access_service/GameAccessResult-class.html">GameAccessResult</a></span>&gt;</span></span>
<span class="name ">checkAccess</span>(<wbr>{<ol class="parameter-list"> <li><span class="parameter" id="checkAccess-param-context"><span>required</span> <span class="type-annotation"><a href="https://api.flutter.dev/flutter/widgets/BuildContext-class.html">BuildContext</a></span> <span class="parameter-name">context</span>, </span></li>
<li><span class="parameter" id="checkAccess-param-scenario"><span>required</span> <span class="type-annotation"><a href="../../features_game_models_scenario/Scenario-class.html">Scenario</a></span> <span class="parameter-name">scenario</span>, </span></li>
<li><span class="parameter" id="checkAccess-param-playerProvider"><span>required</span> <span class="type-annotation"><a href="../../features_auth_providers_player_provider/PlayerProvider-class.html">PlayerProvider</a></span> <span class="parameter-name">playerProvider</span>, </span></li>
<li><span class="parameter" id="checkAccess-param-requestProvider"><span>required</span> <span class="type-annotation"><a href="../../features_game_providers_game_request_provider/GameRequestProvider-class.html">GameRequestProvider</a></span> <span class="parameter-name">requestProvider</span>, </span></li>
<li><span class="parameter" id="checkAccess-param-role"><span class="type-annotation"><a href="../../core_enums_user_role/UserRole.html">UserRole</a></span> <span class="parameter-name">role</span> = <span class="default-value">UserRole.player</span>, </span></li>
<li><span class="parameter" id="checkAccess-param-entryFee"><span class="type-annotation"><a href="https://api.flutter.dev/flutter/dart-core/double-class.html">double</a>?</span> <span class="parameter-name">entryFee</span>, </span></li>
</ol>})

      

    </section>
    
<section class="desc markdown">
  <p>Checks all conditions (Location, FakeGPS, Auth, Session, Participation)
and returns a decision on what to do next.</p>
<p>For ONLINE events, location validation is completely bypassed.
For ON-SITE events, full location/GPS checks are performed.</p>
<p><code>role</code> - The role the user wants to enter as. Spectators bypass participation checks.
<code>entryFee</code> - Optional entry fee amount for paid events.</p>
</section>


    
<section class="summary source-code" id="source">
  <h2><span>Implementation</span></h2>
  <pre class="language-dart"><code class="language-dart">Future&lt;GameAccessResult&gt; checkAccess({
  required BuildContext context,
  required Scenario scenario,
  required PlayerProvider playerProvider,
  required GameRequestProvider requestProvider,
  UserRole role = UserRole.player,
  double? entryFee,
}) async {

  &#47;&#47; --- SPECTATOR FAST PATH ---
  &#47;&#47; Spectators bypass most validation - they just want to watch
  if (role == UserRole.spectator) {
    return _checkSpectatorAccess(
      playerProvider: playerProvider,
      requestProvider: requestProvider,
      scenario: scenario,
    );
  }

  &#47;&#47; --- PLAYER PATH (existing logic) ---

  &#47;&#47; 1. Location Checks - ONLY for on-site (presencial) events
  final bool isOnlineEvent = scenario.type == &#39;online&#39;;
  bool shouldCheckLocation = !isOnlineEvent; &#47;&#47; Skip entirely for online events

  &#47;&#47; Additionally skip for desktop platforms (development)
  if (shouldCheckLocation) {
    try {
      if (Platform.isWindows || Platform.isLinux || Platform.isMacOS) {
        shouldCheckLocation = false;
      }
    } catch (e) {
      &#47;&#47; On web or unknown platform, keep the original decision
    }
  }

  if (shouldCheckLocation) {
    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) {
        return GameAccessResult(AccessResultType.deniedPermissions, message: &#39;Se requieren permisos de ubicaci贸n para participar&#39;);
      }
    }

    if (permission == LocationPermission.deniedForever) {
      return GameAccessResult(AccessResultType.deniedForever, message: &#39;Los permisos de ubicaci贸n est谩n denegados permanentemente.&#39;);
    }

    &#47;&#47; Check for Fake GPS
    try {
      final position = await Geolocator.getCurrentPosition(timeLimit: const Duration(seconds: 5));
      if (position.isMocked) {
         return GameAccessResult(AccessResultType.fakeGps, message: &#39;Se ha detectado el uso de una aplicaci贸n de ubicaci贸n falsa.&#39;);
      }
    } catch (e) {
      &#47;&#47; Ignore location errors here for now, proceed
    }
  }

  &#47;&#47; 2. Auth Session Check
  if (playerProvider.currentPlayer == null) {
     return GameAccessResult(AccessResultType.sessionInvalid, message: &#39;Sesi贸n no v谩lida.&#39;);
  }

  final String userId = playerProvider.currentPlayer!.userId;

  &#47;&#47; 3. Participant Status (Gatekeeper) - CHECK FIRST
  try {
    final participantData = await requestProvider.isPlayerParticipant(userId, scenario.id);
    final isGamePlayer = participantData[&#39;isParticipant&#39;] as bool;
    final playerStatus = participantData[&#39;status&#39;] as String?;

    bool shouldCheckJoin = !isGamePlayer;

    if (isGamePlayer) {
      &#47;&#47; User is ALREADY in the event
      if (playerStatus == &#39;suspended&#39; || playerStatus == &#39;banned&#39;) {
         &#47;&#47; NEW: Allow banned users to spectate
         return GameAccessResult(
           AccessResultType.bannedSpectator,
           message: &#39;Est谩s suspendido de esta competencia. Solo puedes observar.&#39;,
           role: UserRole.spectator,
           isReadOnly: true,
         );
      }

      if (playerStatus == &#39;spectator&#39;) {
        &#47;&#47; Si el usuario es espectador pero quiere entrar como JUGADOR (role == player),
        &#47;&#47; permitimos que contin煤e hacia la validaci贸n de cupo (upgrade).
        if (role == UserRole.spectator) {
           return GameAccessResult.spectator(message: &#39;Continuando como espectador&#39;);
        }
        &#47;&#47; Intencional: Fallthrough para permitir upgrade
        shouldCheckJoin = true;
      } else {
        &#47;&#47; Allowed to enter as a player (active, pending, etc handled here or elsewhere?)
        &#47;&#47; Usually &#39;active&#39; or &#39;pending&#39; (pending might be restricted but checking here implies access if returning player)
        &#47;&#47; Wait, if pending, do we allow &#39;player&#39; result?
        &#47;&#47; The old logic returned &#39;player&#39; for anything not spectator&#47;banned&#47;suspended.
        return GameAccessResult.player(data: {&#39;isParticipant&#39;: true});
      }
    }

    if (shouldCheckJoin) {
      &#47;&#47; --- LIMITE DE PARTICIPANTES ---
      &#47;&#47; Verificamos el conteo real en DB para evitar inconsistencias si el usuario no ha refrescado la pantalla
      final realCount = await requestProvider.getParticipantCount(scenario.id);
      if (realCount &gt;= scenario.maxPlayers) {
        &#47;&#47; Si ya era espectador, vuelve a espectador. Si es nuevo, va a espectador.
        return GameAccessResult.spectator(
          message: &#39;El m谩ximo de jugadores (${scenario.maxPlayers}) ya fue alcanzado. Entrando como espectador.&#39;
        );
      }

      &#47;&#47; User is NOT a participant yet (or upgrading from spectator)
      final request = await requestProvider.getRequestForPlayer(userId, scenario.id);

      if (request != null) {
        if (request.isApproved) {
          &#47;&#47; Request is Approved - Allow entry (skip payment check as usually approval implies payment&#47;permission)
          return GameAccessResult.player(data: {&#39;isParticipant&#39;: false, &#39;isApproved&#39;: true});
        } else {
          return GameAccessResult(AccessResultType.requestPendingOrRejected);
        }
      }
      &#47;&#47; If no request exists, proceed to payment check or code check
    }

  } catch (e) {
     return GameAccessResult(AccessResultType.sessionInvalid, message: &#39;Error verificando estado: $e&#39;);
  }

  &#47;&#47; 4. Payment Check (if event requires entry fee AND user is not a participant)
  if (entryFee != null &amp;&amp; entryFee &gt; 0) {
    return GameAccessResult(
      AccessResultType.needsPayment,
      message: &#39;Este evento requiere una inscripci贸n de ${entryFee.toStringAsFixed(2)} &#39;,
      data: {&#39;entryFee&#39;: entryFee},
    );
  }

  &#47;&#47; 5. If no payment needed, but no request found -&gt; Needs Code (or just explicit join for free events)
  return GameAccessResult(AccessResultType.needsCode);
}</code></pre>
</section>


  </div> <!-- /.main-content -->
  <div id="dartdoc-sidebar-left" class="sidebar sidebar-offcanvas-left">
    <!-- The search input and breadcrumbs below are only responsively visible at low resolutions. -->
<header id="header-search-sidebar" class="hidden-l">
  <form class="search-sidebar" role="search">
    <input type="text" id="search-sidebar" autocomplete="off" disabled class="form-control typeahead" placeholder="Loading search...">
  </form>
</header>
<ol class="breadcrumbs gt-separated dark hidden-l" id="sidebar-nav">
    <li><a href="../../index.html">treasure_hunt_rpg</a></li>
    <li><a href="../../features_game_services_game_access_service/">game_access_service</a></li>
    <li><a href="../../features_game_services_game_access_service/GameAccessService-class.html">GameAccessService</a></li>
    <li class="self-crumb">checkAccess method</li>
</ol>

    <h5>GameAccessService class</h5>
    <div id="dartdoc-sidebar-left-content"></div>
  </div><!--/.sidebar-offcanvas-->
  <div id="dartdoc-sidebar-right" class="sidebar sidebar-offcanvas-right">
</div><!--/.sidebar-offcanvas-->
</main>
<footer>
  <span class="no-break">
    treasure_hunt_rpg
      1.0.1+2
  </span>
  
</footer>


<script src="../../static-assets/highlight.pack.js?v1"></script>
<script src="../../static-assets/docs.dart.js"></script>

</body>
</html>

